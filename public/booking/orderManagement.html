<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- w3c -->
    <script src="http://www.w3schools.com/lib/w3data.js"></script>
    
    <!-- jquery & jquery mobile lib -->
    <script src="external/jquery-mobile/jquery.mobile-1.4.5.min.js"></script>
    <script src="scripts/jquery-2.2.0.min.js"></script>
    
    <!-- bootstrap -->
    <script src="scripts/bootstrap.min.js"></script>
    
    <!-- parse lib -->
    <script src="scripts/parse-1.6.14.min.js"></script>
    
    <!-- handlebars -->
    <script src="scripts/handlebars-v4.0.5.js"></script>
    
    <!-- app's lib -->
    <script src="js/parse-conn.js"></script>
    <script src="js/app.js"></script>
    
    <!-- jquery mobile style -->
    <link rel="stylesheet" href="external/jquery-mobile/jquery.mobile-1.4.5.css" />
    
    <!-- bootstrap style -->
    <link rel="stylesheet" href="css/bootstrap.min.css" >
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    
    <title>國王早餐-訂單查詢</title>
    
	<script>
	    $(function(){
			checkIfUserLoggedIn();
			
			loadTimeSlot();
		});
	</script>
	
</head>
<body>

    <div w3-include-html="menu.html"></div>

	<script>
		w3IncludeHTML();
	</script>

   
    <div class="panel panel-default" style="width:80%; margin-left: 20px; margin-right: 20px;">
        <div class="panel-heading">訂單管理</div>

        <div class="panel-body">
            <div>
				<div class="ui-grid-d" >
					<div class="ui-block-a" style="width:10%">
		    			<label>出餐日:</label>
	                    <select class="form-control" id="select-day">
	                        <option value="today">今日</option>
	                        <option value="yestday">昨日</option>
	                        <option value="tomorrow">明日</option>
	                    </select>
		    		</div>
		    		<div class="ui-block-b" style="width:2%">
		    			
		    		</div>
		    		<div class="ui-block-c" style="width:10%">
		    			<label>出餐時段:</label>
	                    <select class="form-control" id="select-timeslot">
	                    </select>
		    		</div>
		    		<div class="ui-block-d" style="width:2%">
		    			
		    		</div>
		    		<div class="ui-block-e" style="width:30%">
		    			<label>&nbsp;</label>
		    			<button type="submit" class="btn btn-default" id="orderSearchBtn1">查詢</button>
		    		</div>
				</div>
            </div>
        </div>
        
        

        <div class="panel panel-default" style="text-align:center;margin-left: 20px; margin-right: 20px;">
        	<label>餐點數量統計表:</label>
	        <table class="table table-striped " >
	            <thead>
	                <tr>
	                    <th>#</th>
	                    <th>訂單產生日期</th>
	                    <th>送餐日期及時段</th>
	                    <th>訂餐人</th>
	                    <th>訂購內容</th>
	                </tr>
	            </thead>
	            
	            <tbody id="orderTableBody"></tbody>
	        </table>
        </div>
        
    </div>
    
    <script id="timeSlot-template" type="text/x-handlebars-template">
    	<option value="all">全部</option>
		{{#each this}}
			<option value="{{id}}">{{interval}}</option>
		{{/each}}
	</script>
	
    <script id="summaryByBuyer-template" type="text/x-handlebars-template">
		{{#each this}}
			<tr>
                <td>{{ @index }}</td>
                <td>{{ submittedDate }}</td>
                 <td>{{ etaString }}</td>
                <td>{{ contactPerson }}</td>
                <td>
                	{{ foodlist }}
                </td>
            </tr>
		{{/each}}
	</script>
    

    <script>
        $(function () {
			
			loadTimeSlot();
			
			            

            var searchOrder = function (dateFrom, dateTo) {
                
                var template = Handlebars.compile($("#my-cart-template").html());
			
				$("#itemInJoinCart").html(template(results[0]));
                
                
                $("#orderTableBody tr").remove();
                var HBShoppingCart = Parse.Object.extend("HBShoppingCart");
                var query = new Parse.Query(HBShoppingCart);
                query.exists('submittedDate');
				
                query.greaterThan("ETA", dateFrom);
                query.lessThan("ETA", dateTo);
                query.ascending("ETA");
                query.find({
                    success: function (carts) {
                        $("#orderTableBody tr").remove();
                        console.log("carts size = " + carts.length);
                        carts.forEach(function (cart, index, array) {

                            $('#orderTableBody').append(
                              $('<tr>').append(
                                  $('<td>').html(index + 1), //#
                                  $('<td>').html(format(cart.get('submittedDate'), 'yyyy-MM-dd hh:mm')),
                                  $('<td>').html($('<a href=orderInfo.html?objectId=' + cart.id + ' target=_blank>').html(cart.id)),
                                  $('<td id=' + cart.id + '>').html(""))
                              );

                        });

                    }, error: function (e) {
                        alert(e);
                    }

                });

            };

            var searchOrderById = function (id) {
                $("#orderTableBody tr").remove();
                var HBShoppingCart = Parse.Object.extend("HBShoppingCart");
                var query = new Parse.Query(HBShoppingCart);
                query.include('bee');
                query.get(id, {
                    success: function (cart) {
                        $("#orderTableBody tr").remove();
                        $('#orderTableBody').append(
                             $('<tr>').append(
                                 $('<td>').html("1"), //#
                                 $('<td>').html(format(cart.get('submittedDate'), 'yyyy-MM-dd hh:mm')),
                                 $('<td>').html(cart.get('paymentMethod') === 'cashForStore' ? "店家叫外送" : "App點餐"),
                                 $('<td>').html($('<a href=orderInfo.html?objectId=' + cart.id + ' target=_blank>').html(cart.id)),
                                 $('<td id=' + cart.id + '>').html(""),
                                 $('<td>').html(cart.get('bee') != null ? $('<a href=beeInfo.html?objectId=' + cart.get('bee').id + ' target=_blank>').html(cart.get('bee').get("contact")) : ""),
                                 $('<td>').html(isBeeTakeOff(cart) ? covertShoppingCartStatus(cart) : '<font color = orange>' + covertShoppingCartStatus(cart) + '</font>'),
                                 $('<td>').html(format(cart.get('ETD'), 'yyyy-MM-dd') + " " + format(cart.get('ETD'), 'hh:mm') + "/" + format(cart.get('ETA'), 'hh:mm'))
                             )
                          );


                        var HBStoreInCart = Parse.Object.extend("HBStoreInCart");

                        var storeInCartQuery = new Parse.Query(HBStoreInCart);
                        storeInCartQuery.equalTo("cart", cart);
                        storeInCartQuery.include("store");
                        storeInCartQuery.find({
                            success: function (storeInCarts) {
                                var len = storeInCarts.length;
                                var names = "";
                                storeInCarts.forEach(function (storeInCart, sIndex, array) {
                                    var storeName = storeInCart.get('store').get('storeName');
                                    names += storeName;
                                    if (sIndex != len - 1) {
                                        names += ",";
                                    }
                                    console.log("storeName: " + names);
                                    $("#" + cart.id).html(names);

                                });

                            }

                        });

                    }, error: function (e) {
                        alert("查無此訂單");
                    }
                });
            };

            //init();

            $('#orderSearchBtn1').click(function () {
                var tmpDate = format(new Date(), 'yyyy-MM-dd');
                //alert(tmpDate);
                var dateFrom = new Date(tmpDate);
                var dateTo = new Date(tmpDate);

                var slectVal = $("#select-day").val();
                if (slectVal === "today") {
                    dateTo.setDate(dateTo.getDate() + 1);
                } else if (slectVal === "yestday") {
                    dateFrom.setDate(dateFrom.getDate() - 1);
                    dateTo.setDate(dateFrom.getDate() + 1);
                } else if (slectVal === "tomorrow") {
                    dateFrom.setDate(dateFrom.getDate() + 1);
                    dateTo.setDate(dateFrom.getDate() + 1);
                }
                searchOrder(dateFrom, dateTo);
            });

            
        });

    </script>
</body>
</html>