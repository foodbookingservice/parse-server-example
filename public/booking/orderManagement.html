<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="scripts/parse-1.6.14.min.js"></script>
    <script src="hungrybee.js"></script>
    <script src="scripts/hbParseInit.js"></script>
    <script src="scripts/hbUtility.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>-->

    <!-- Latest compiled and minified CSS -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">-->
    <!-- Optional theme -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">-->
    <!-- Latest compiled and minified JavaScript -->
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>-->

    <script src="scripts/jquery-2.2.0.min.js"></script>
    <script src="scripts/bootstrap.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">
    <title>小蜜蜂小幫手</title>
</head>
<body>

    <ul class="nav nav-pills">
    	<li role="presentation" class="dropdown"><a href="https://hungrybeedashboard.herokuapp.com/apps/HungryBee/" target=_new>資料庫後台</a></li>
        
        <li role="presentation" class="dropdown active">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                訂單查詢 <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                <li><a href="index.html?mode=id">訂單編號</a></li>
                <li><a href="index.html?mode=date">訂單日期</a></li>
                <li><a href="phoneSearch.html">依訂購人查詢</a></li>
            </ul>
            <!--<a href="index.html">訂單查詢</a>-->
        </li>


        <li role="presentation"><a href="createStoreProfile.html">餐點資料維護</a></li>
        <li role="presentation" class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                其他 <span class="caret"></span>
            </a>

            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                <li><a href="" onclick="parseLogOut()">登出</a></li>
            </ul>
        </li>
        
    </ul>

    <br>

    <div class="panel panel-default">
        <div class="panel-heading">訂單管理</div>

        <div class="panel-body">
            <div class="navbar-form navbar-left">

                <div class="form-group">

                    <span class="label label-primary">1</span><br />
                    <label>快速查詢:</label>
                    <select class="form-control" id="select-day">
                        <option value="today">今日</option>
                        <option value="yestday">昨日</option>
                        <option value="tomorrow">明日</option>
                    </select>
                    <button type="submit" class="btn btn-default" id="orderSearchBtn1">查詢</button>
                </div>

                <p> or </p>

                <div class="form-group">
                    <span class="label label-primary">2</span><br>
                    <label for="dateFrom">時間: </label>
                    <input id="dateFrom" type="date" class="form-control" min="2015-01-02">
                    <label for="sel1">~</label>
                    <input id="dateTo" type="date" class="form-control" min="2015-01-02">
                    <button type="submit" class="btn btn-default" id="orderSearchBtn2">查詢</button>

                </div>

                <p> or </p>

                <div class="form-group">
                    <span class="label label-primary">3</span><br />
                    <label>訂單編號:</label>
                    <input type="text" class="form-control" placeholder="請輸入訂單編號" id="orderNumberInput">
                    <button type="submit" class="btn btn-default" id="orderSearchBtn3">查詢</button>
                </div>

                <!--<p></p>
                <div class="form-group">
                    <span class="label label-primary">test</span><br />
                    <label>test:</label>
                    <button type="submit" class="btn btn-default" id="testBtn">測試</button>
                </div>-->
            </div>

        </div>

        <table class="table table-striped ">
            <thead>
                <tr>
                    <th >#</th>
                    <th>成立時間</th>
                    <th>類型</th>
                    <th>訂餐人</th>
                    <th>編號</th>
                    <th>取餐店家</th>
                    <th>小蜜蜂</th>
                    <th>狀態</th>
                    <th>取餐 / 送達時間</th>
                </tr>
            </thead>
            <tbody id="orderTableBody"></tbody>
        </table>

        <!--<nav>
            <ul class="pagination">
                <li><a href="#"><span aria-hidden="true">&laquo;</span><span class="sr-only">Previous</span></a></li>
                <li><a href="#">1</a></li>
                <li><a href="#">2</a></li>
                <li><a href="#">3</a></li>
                <li><a href="#">4</a></li>
                <li><a href="#">5</a></li>
                <li><a href="#"><span aria-hidden="true">&raquo;</span><span class="sr-only">Next</span></a></li>
            </ul>
        </nav>-->

    </div>

    <script>
        $(function () {
            //var parseInit = function () {
            //    Parse.initialize("9O3uQHctMnz86F6m3lifIlwKrMGONwlUjO2OL4uf", "nbkR1HRcOkFEa4J73rPsWvaZsqa6O6BHI0GSGClz");

            //    //test
            //    //Parse.initialize("UWZqpCsyFQWnyLTChFrK6t19NyLtmm7m0W2gP2ul", "GSmSLSAz7FfGyfXXB9wCvtwIJULXPHBFkM2PzwdZ");

            //}

            //var init = function () {
            //    parseInit();
            //}

            var isBeeTakeOff = function (cart) {

                var status = cart.get("status");
                var beeTakeOff = cart.get("beeTakeoff");
                
                if (beeTakeOff || isEquality(status, "complete")) {
                    return true;
                }

                return false;
            };


            var covertShoppingCartStatus = function (cart) {
                var status = cart.get("status");
            
                if (!isBeeTakeOff(cart)) {
                	if(isEquality(status, "ongoing")||isEquality(status, "shipping")){
                    	return "未出發";
                   }
                }

                if (isEquality(status, "complete")) {
                    return "完成";
                } else if (isEquality(status, "ongoing")) {
                    return "取餐中";
                } else if (isEquality(status, "shipping")) {
                    return "送餐中";
                } else if (isEquality(status, "onbid")) {
                    return "競標中";
                } else if (isEquality(status, "cancel")) {
                    return "取消";
                } else {
                    return status;
                }

            };


            var searchOrder = function (dateFrom, dateTo) {
                $("#orderTableBody tr").remove();
                var HBShoppingCart = Parse.Object.extend("HBShoppingCart");
                var query = new Parse.Query(HBShoppingCart);
                //query.include('sendTo');
                //query.include('owner');
                query.include('bee');
                query.exists('submittedDate');
				
                query.greaterThan("ETA", dateFrom);
                query.lessThan("ETA", dateTo);
                query.ascending("ETA");
                query.limit(1000);
                query.find({
                    success: function (carts) {
                        $("#orderTableBody tr").remove();
                        console.log("carts size = " + carts.length);
                        carts.forEach(function (cart, index, array) {

                            $('#orderTableBody').append(
                              $('<tr>').append(
                                  $('<td>').html(index + 1), //#
                                  $('<td>').html(format(cart.get('submittedDate'), 'yyyy-MM-dd hh:mm')),
                                  $('<td>').html(cart.get('paymentMethod') === 'cashForStore' ? "店家叫外送" : "App點餐"),
                                  $('<td>').html(cart.get('paymentMethod') === 'cashForStore' ? "" : cart.get("contactPerson")),
                                  $('<td>').html($('<a href=orderInfo.html?objectId=' + cart.id + ' target=_blank>').html(cart.id)),
                                  $('<td id=' + cart.id + '>').html(""),
                                  $('<td>').html(cart.get('bee') != null ? $('<a href=beeInfo.html?objectId=' + cart.get('bee').id + ' target=_blank>').html(cart.get('bee').get("contact")) : ""),
                                  $('<td>').html(!isBeeTakeOff(cart) && (isEquality(cart.get('status'), "ongoing")||isEquality(cart.get('status'), "shipping")) ? '<font color = orange>' + covertShoppingCartStatus(cart) + '</font>':covertShoppingCartStatus(cart)),
                                  $('<td>').html(format(cart.get('ETD'), 'yyyy-MM-dd') + " " + format(cart.get('ETD'), 'hh:mm') + "/" + format(cart.get('ETA'), 'hh:mm'))
                              )
                           );

                            var HBStoreInCart = Parse.Object.extend("HBStoreInCart");

                            var storeInCartQuery = new Parse.Query(HBStoreInCart);
                            storeInCartQuery.equalTo("cart", cart);
                            storeInCartQuery.include("store");
                            storeInCartQuery.find({
                                success: function (storeInCarts) {
                                    var len = storeInCarts.length;
                                    var names = "";
                                    storeInCarts.forEach(function(storeInCart,sIndex,array){
                                        var storeName = storeInCart.get('store').get('storeName');
                                        names += storeName;
                                        if (sIndex != len - 1) {
                                            names+=",";
                                        }
                                        //console.log("storeName: " + names);
                                        $("#" + cart.id).html(names);

                                    });
     
                                }

                            });


                        });

                    }, error: function (e) {
                        alert(e);
                    }

                });

            };

            var searchOrderById = function (id) {
                $("#orderTableBody tr").remove();
                var HBShoppingCart = Parse.Object.extend("HBShoppingCart");
                var query = new Parse.Query(HBShoppingCart);
                query.include('bee');
                query.get(id, {
                    success: function (cart) {
                        $("#orderTableBody tr").remove();
                        $('#orderTableBody').append(
                             $('<tr>').append(
                                 $('<td>').html("1"), //#
                                 $('<td>').html(format(cart.get('submittedDate'), 'yyyy-MM-dd hh:mm')),
                                 $('<td>').html(cart.get('paymentMethod') === 'cashForStore' ? "店家叫外送" : "App點餐"),
                                 $('<td>').html($('<a href=orderInfo.html?objectId=' + cart.id + ' target=_blank>').html(cart.id)),
                                 $('<td id=' + cart.id + '>').html(""),
                                 $('<td>').html(cart.get('bee') != null ? $('<a href=beeInfo.html?objectId=' + cart.get('bee').id + ' target=_blank>').html(cart.get('bee').get("contact")) : ""),
                                 $('<td>').html(isBeeTakeOff(cart) ? covertShoppingCartStatus(cart) : '<font color = orange>' + covertShoppingCartStatus(cart) + '</font>'),
                                 $('<td>').html(format(cart.get('ETD'), 'yyyy-MM-dd') + " " + format(cart.get('ETD'), 'hh:mm') + "/" + format(cart.get('ETA'), 'hh:mm'))
                             )
                          );


                        var HBStoreInCart = Parse.Object.extend("HBStoreInCart");

                        var storeInCartQuery = new Parse.Query(HBStoreInCart);
                        storeInCartQuery.equalTo("cart", cart);
                        storeInCartQuery.include("store");
                        storeInCartQuery.find({
                            success: function (storeInCarts) {
                                var len = storeInCarts.length;
                                var names = "";
                                storeInCarts.forEach(function (storeInCart, sIndex, array) {
                                    var storeName = storeInCart.get('store').get('storeName');
                                    names += storeName;
                                    if (sIndex != len - 1) {
                                        names += ",";
                                    }
                                    console.log("storeName: " + names);
                                    $("#" + cart.id).html(names);

                                });

                            }

                        });

                    }, error: function (e) {
                        alert("查無此訂單");
                    }
                });
            };

            //init();

            $('#orderSearchBtn1').click(function () {
                var tmpDate = format(new Date(), 'yyyy-MM-dd');
                //alert(tmpDate);
                var dateFrom = new Date(tmpDate);
                var dateTo = new Date(tmpDate);

                var slectVal = $("#select-day").val();
                if (slectVal === "today") {
                    dateTo.setDate(dateTo.getDate() + 1);
                } else if (slectVal === "yestday") {
                    dateFrom.setDate(dateFrom.getDate() - 1);
                    dateTo.setDate(dateFrom.getDate() + 1);
                } else if (slectVal === "tomorrow") {
                    dateFrom.setDate(dateFrom.getDate() + 1);
                    dateTo.setDate(dateFrom.getDate() + 1);
                }
                searchOrder(dateFrom, dateTo);
            });

            $('#orderSearchBtn2').click(function () {
                var dateFrom = new Date($("#dateFrom").val());
                var dateTo = new Date($("#dateTo").val());
                dateTo.setDate(dateTo.getDate() + 1);

                searchOrder(dateFrom, dateTo);
            });

            $('#orderSearchBtn3').click(function () {
                searchOrderById($('#orderNumberInput').val());
            });

            //$('#testBtn').click(function () {

            //    //Parse.Cloud.run("restartBeeLocationService", { cartId: "5O7LNWucNj" }, {
            //    //    success: function (isSuccess) {

            //    //        console.log("restartBeeLocationService isSuccess = " + isSuccess);

            //    //    }, error: function (error) {
            //    //        console.log(error);
            //    //    }

            //    //});

            //    //var HBCustomerInCart = Parse.Object.extend("HBCustomerInCart");
            //    //var customerInCartQuery = new Parse.Query(HBCustomerInCart);
            //    //customerInCartQuery.equalTo('cart', Parse.Object.extend("HBShoppingCart").createWithoutData(/*request.params.cartId*/));
            //    //customerInCartQuery.find({
            //    //    success: function (customerInCarts) {
            //    //        customerInCarts.forEach(function (customerInCart, index, array) {
            //    //            customerInCart.set("delivered", true);
            //    //            customerInCart.save();
            //    //        });

            //    //    }, error: function (e) {
            //    //        console.log("error: " + e);
            //    //    }

            //    //});

            //    //var HBCustomerInCart = Parse.Object.extend("HBCustomerInCart");
            //    //var customerInCartQuery = new Parse.Query(HBCustomerInCart);
            //    //customerInCartQuery.equalTo('cart',"cs8Z0mzRml");
            //    //customerInCartQuery.find({
            //    //    success: function (customerInCarts) {

            //    //        customerInCarts.forEach(function (customerInCart, index, array) {
            //    //            customerInCart.set("delivered", true);
            //    //            customerInCart.save();
            //    //        });

            //    //    }, error: function (e) {

            //    //    }
            //    //});


            //    var user = Parse.User.current();
            //    if (user == null) {
            //        console.log("user = null");
            //    } else {
            //        console.log("user id = " + user.id);
            //    }

            //    user.fetch({
            //        success: function (currentUser) {

            //            user = currentUser;
            //            console.log("user = " + user.id);

            //        }, error: function (e) {

            //            console.log("e = " + e);

            //        }
            //    });

            //    Parse.User.logOut().then(() => {
            //        var currentUser = Parse.User.current();  // this will now be null
            //    });

            //    Parse.User.logIn("customer001", "123456", {
            //        success: function (user) {

            //            var user = Parse.User.current();
            //            if (user == null) {
            //                console.log("user = null");
            //            } else {
            //                console.log("user id = " + user.id);
            //                var qualify =  user.get('qualify');
            //                console.log("user qualify = " + qualify);
            //            }

            //        },
            //        error: function (user, error) {

            //            console.log("The login failed. Check error to see why.");

            //            // The login failed. Check error to see why.
            //        }
            //    });

            //});
        });

    </script>
</body>
</html>