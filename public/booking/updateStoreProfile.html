<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<script src="http://www.w3schools.com/lib/w3data.js"></script>
	<script src="scripts/parse-1.6.14.min.js"></script>
    <script src="scripts/jquery-2.2.0.min.js"></script>
    <script src="scripts/bootstrap.min.js"></script>
    <script src="scripts/hbUtility.js"></script>
    <script src="hungrybee.js"></script>
    <script src="scripts/hbParseInit.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
    <script src="scripts/jquery.switchButton.js"></script>
    <link href="https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
    <script src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
	<!-- handlebar -->
    <script src="scripts/handlebars-v4.0.5.js"></script>
    
    <link href="css/jquery.switchButton.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="css/storeManagement.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	

		
	<script type="text/javascript">
		function upload() {
			$('#create_loading').css("display", "block");
			$('#uploadBtn').attr("disabled", true);
			
			var filename = document.getElementById("profilePhotoFileUpload").value;
			filename = filename.substring(filename.lastIndexOf("\\") + 1)
			
			var fileUploadControl = $("#profilePhotoFileUpload")[0];
			var objectId = $("#objectId").val();
			var className = $('input:radio:checked[name="className"]').val();
			if (fileUploadControl.files.length > 0) {
			  	var file = fileUploadControl.files[0];	
			  	var reader = new FileReader();
			  	var img = new Image();
			  	reader.onload = function(e) {
			  		img.src = e.target.result;
			  		img.onload = function() {
			  			var imgWidth = this.width;
			  			var imgHeight = this.height;
			  			
			  			//save to parse
			  			var parseFile = new Parse.File(filename, file);
					  	parseFile.save().then(
					  		function() {
					  			var acl = new Parse.ACL();
								acl.setPublicReadAccess(true);
			
					  			var HBLob = Parse.Object.extend("HBLob");
						  		var lob = new HBLob();
						  		lob.set("category", className);
						  		lob.set("data", parseFile);
						  		lob.set("fileName", filename);
						  		lob.set("fileWidth", imgWidth);
						  		lob.set("fileHeight", imgHeight);
						  		lob.setACL(acl);
						  		lob.save(null, {
					        		success: function(lobCreated) {
					        			//Parse.Cloud.useMasterKey();
					        			console.log("className:" + className);
					        			console.log("lobCreated:" + lobCreated.id);
					        			
					        			if (className == "HBFoodStore") {
					        				var storeId = $("#storeId").val();
					        				var query = new Parse.Query("HBFoodStore");
											query.get(storeId, {
											  	success: function(storeFound) {
											  		storeFound.set("storeImage", lobCreated);
											  		storeFound.save();	
											  		$('#create_loading').css("display","none");	
											  		$("#uploadBtn").removeAttr("disabled");
											 	},
											  	error: function(object, err) {
													console.error(err);
												}
											});
					        			
					        			} else if (className == "HBPromotion") {
					        				var storeId = $("#storeId").val();
					        				var foodStore = Parse.Object.extend("HBFoodStore");
											var store = new foodStore();
											store.id = storeId;
					        				
					        				var HBPromotion = Parse.Object.extend("HBPromotion");
						  					var promotion = new HBPromotion();
						  					promotion.set("promoteType", "store");
						  					promotion.set("brief", "店家宣傳廣告");
						  					promotion.set("forStore", store);
						  					promotion.set("thumbnail", lobCreated);
						  					promotion.setACL(acl);
						  					promotion.save(null,{
											        	success: function(promotionCreated) {
											        		console.log("promotion Created:" + promotionCreated.id);
											        		$('#create_loading').css("display","none");	
											        		$("#uploadBtn").removeAttr("disabled");	
											        	},
											        	error: function(err) {
											        		console.error("create promotion image error:", JSON.stringify(err));	
											        	}	
											        });
					        			
					        			} else if (className == "HBMealSet") {
					        				var imageType = $('input:radio:checked[name="imageType"]').val();
					        				var mealId = $("#mealId").val();
					        				var food = new Parse.Query("HBMealSet");
											food.get(mealId, {
											  	success: function(foodFound) {
											  		if (imageType == "small") {
											  			foodFound.set("thumbnail", lobCreated);
											  		} else {
											  			foodFound.set("foodImage", lobCreated);
											  		}
											  		foodFound.save(null,{
											        	success: function(foodUpdated) {
											        		console.log(foodFound.get("mealName") + " Updated:" + foodUpdated.id);	
											        		$('#create_loading').css("display","none");	
											        		$("#uploadBtn").removeAttr("disabled");
											        	},
											        	error: function(err) {
											        		console.error("foodUpdated error", JSON.stringify(err));	
											        	}	
											        });
											 	},
											  	error: function(err) {
											  		
													console.error("save food error:" + JSON.stringify(err));
												}
											});
					        			}
					        			
					        				
					        		},
					        		error: function(error) { 
					        			esponse.error(error);
					        		}
					        	});
							  		
						  		
						  		
						  		
						  		
						  		//console.log("save " + filename + " ok");
					  		}, 
					  		function(error) {
						  		alert("save file error" + error);
					  		}
					  	);
			  			
			  			//~
			  			
			  			
			  		};
			  	};
			  	reader.readAsDataURL(file);
			  	
			  	/*
			  	
			  	*/
			}
		}
	</script>
	
	<script>
		$(function() {
		    loadStore();
		});
		
		//load store
		function loadStore() {
			var query = new Parse.Query("HBFoodStore");
			query.equalTo("online", true);	
			query.find()
				.then(function(results) {
					var template = Handlebars.compile($("#store-list-template").html());
					var stores = [];
					$(results).each(function(i,e){
						var store = e.toJSON();
						if (e.get("storeName") != "app promotion") {
							stores.push(store);
						}
					});
					
					$("#selectStore").html(template(stores));
				}, function (err) {
					console.log("error:" + error);
				});
		}
		
		//選店家
		$(document).on("change", "#selectStore" ,function (event) {
			var storeId = $("#selectStore option:selected").attr("storeId");
			$("#storeId").val(storeId);
		});
	</script>
	
	<script id="store-list-template" type="text/x-handlebars-template">
		<option value="---"> --- 請選擇 ---</option>
		{{#each this}}
			<option value="{{objectId}}" storeId="{{objectId}}" mealId="{{mealId}}" ownerId="{{ownerId}}">{{storeName}}</option>
		{{/each}}
	</script>
	
	
</head>


<body id="main">

<div w3-include-html="menu.html"></div>
<script>
		w3IncludeHTML();
	</script>
		
<h1>更新店鋪圖片資料</h1>

<form name="uploadForm">
	<table>
		<tr>
			<td colspan="3">1. 先選店家:</td>
		</tr>
		<tr>
			<td colspan="3">
				&nbsp;&nbsp;&nbsp;
				<select name="selectStore" id="selectStore"></select>
				<input type="hidden" id="storeId" name="storeId">
				</td>
		</tr>
		<tr>
			<td colspan="3">2. 請選要更新哪一類的圖片:</td>
		</tr>
		<tr>
			<td>&nbsp;&nbsp;&nbsp;<input type="radio" name="className" value="HBFoodStore"></td>
			<td>店家在美食地圖的圖片</td>
			<td><img src="images/home.png" width="130" height="161"></td>
		</tr>
		<tr>
			<td>&nbsp;&nbsp;&nbsp;<input type="radio" name="className" value="HBPromotion"></td>
			<td>宣傳圖320x96</td>
			<td><img src="images/promotion.png" width="200" height="98"></td>
		</tr>
		<tr>
			<td colspan="3"><BR>3. 請選圖片:</td>
		</tr>
		<tr>
			<td colspan="3">&nbsp;&nbsp;&nbsp;<input type="file" id="profilePhotoFileUpload">(.png file)</td>
		</tr>
		<tr>
			<td colspan="3" align="center"><BR>
				<input type="button" id="uploadBtn" value="upload" onclick="upload()">	
			</td>
		</tr>
	</table>
	
	
	
	
	<!--
	<input type="radio" name="className" value="HBMealSet">店家餐點圖<BR>
	&nbsp;&nbsp;&nbsp;MealId:<input type="mealId" id="mealId"><BR>
	&nbsp;&nbsp;&nbsp;<input type="radio" name="imageType" value="small">155x155<BR>
	&nbsp;&nbsp;&nbsp;<input type="radio" name="imageType" value="large">677x450<BR><BR>
	-->
	
	
	
	<div id="create_loading" style="display:none">
		<img src="ajax-loader.gif">processing...
	</div>
</form>



</body>

</html>

