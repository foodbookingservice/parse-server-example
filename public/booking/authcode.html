<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="scripts/parse-1.6.14.min.js"></script>
    <script src="hungrybee.js"></script>
    <script src="scripts/hbParseInit.js"></script>
    <script src="scripts/hbUtility.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>-->

    <!-- Latest compiled and minified CSS -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">-->
    <!-- Optional theme -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">-->
    <!-- Latest compiled and minified JavaScript -->
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>-->

    <script src="scripts/jquery-2.2.0.min.js"></script>
    <script src="scripts/bootstrap.min.js"></script>
    
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">
	
    <title>後台產生使用者認證</title>

    <style>
        .ui-widget-header, .ui-state-default, ui-button {
            background: #faa732;
            border: 1px solid #faa732;
            color: #FFFFFF;
            Font-family: Ms Gothic;
            /*font-weight: bold;*/
        }
    </style>


    <!--<script type="text/javascript" src="https://www.google.com/jsapi"></script>-->
 


</head>
<body id="main">
    

    <div class="panel panel-default">
        <div class="panel-heading">認證碼產生器</div>
		
        <div class="panel-body">
            <div class="navbar-form navbar-left">
                <div class="form-group">
                  
                    <label>手機:</label>
                    <input type="text" class="form-control" placeholder="請輸入手機號碼" id="phoneInput">
                   	&nbsp;&nbsp;
                   	<input type="radio" name="userType" value="bee"> 外送小蜜蜂
                    &nbsp;&nbsp;&nbsp;
						<input type="radio" name="userType" value="user"> APP點餐消費者
                   &nbsp;&nbsp;&nbsp;
                   
                   		<button type="submit" class="btn btn-default" id="SearchBtn">查詢</button>
                   	
                </div>
                
                
            </div>
        </div>

        <table class="table table-striped ">
            <thead>
                <tr>
                    <th>#</th>
                    <th>第一次註冊時間</th>
                    <th>電話</th>
                    <th>免簡訊註冊</th>
                    <th>動作</th>
                </tr>
            </thead>
            <tbody id="beeTableBody">
               
            </tbody>
        </table>
		<div id="create_loading" style="display:none;text-align:center;">
			<img src="ajax-loader.gif">
		</div>
        <div style="text-align:center">
        	<h3><font color="red"><span id="generateResult"></span></font></h3>
        </div>
    </div>

    <script>
        function setBypassState(userId, bypass) {
        	
        	if(confirm("確定要執行?")) {
        		$('#create_loading').css("display", "block");
				$('#gen-code').attr("disabled", true);
				
				Parse.Cloud.run("updateUserProfile", 
					{	
						userId: userId,
						bypass: bypass
					}, 
					{
					success: function(results){
						$('#create_loading').css("display", "none");
						$('#gen-code').attr("disabled", false);
						if(bypass) {
							$('#generateResult').html("將此認證碼提供給使用者進行登入: " + results);
						} else {
							$('#generateResult').html("取消成功");
						}
						
					},
				 	error: function(error) {
				 		$('#create_loading').css("display", "none");
				 		$('#gen-code').attr("disabled", false);
				 		$('#generateResult').html("執行失敗: " + error);
					}
				});	
        	}
        }
       
        $('#SearchBtn').click(function () {
			$('#generateResult').html("");
            $("#beeTableBody tr").remove();
            var userType = $('input:radio:checked[name="userType"]').val();
            var username = "";
            if (userType == "bee") {
            	username = "driver-" + $('#phoneInput').val();
            } else {
            	username = $('#phoneInput').val();
            }

            var query = new Parse.Query(Parse.User);
            query.equalTo("username", username);
            query.find({
                success: function (users) {

                    if (users.length == 0) {
                        alert("查無此註冊人員");
                    } else if (users.length > 1) {
                        alert("有相同的username");
                    }

                    users.forEach(function (user, index, array) {
						if(user.get("bypass")) {
							$('#beeTableBody').append(
	                            $('<tr>').append(
	                                $('<td>').html(index + 1), //#
	                                $('<td>').html(format(user.get('createdAt'), 'yyyy-MM-dd hh:mm')),
	                                $('<td>').html(user.getUsername()),
	                                $('<td>').html("是"),
	                                $('<td>').html($('<a href="#" class="btn btn-primary btn-lg" role="button" id="gen-code" onclick="setBypassState(\'' + user.id + '\', false)">').html("取消免簡訊註冊"))
	                            )
	                         );
						} else {
							$('#beeTableBody').append(
	                            $('<tr>').append(
	                                $('<td>').html(index + 1), //#
	                                $('<td>').html(format(user.get('createdAt'), 'yyyy-MM-dd hh:mm')),
	                                $('<td>').html(user.getUsername()),
	                                $('<td>').html("否"),
	                                $('<td>').html($('<a href="#" class="btn btn-primary btn-lg" role="button" id="gen-code" onclick="setBypassState(\'' + user.id + '\', true)">').html("設定免簡訊註冊"))
	                            )
	                         );
						}
                        

                    });

                }, error: function (error) {
                    //alert(ex);

                    //console.log(ex);
                }
            });

        });


    </script>


</body>
</html>