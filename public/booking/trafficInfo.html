<!DOCTYPE html>
<html>
<head>
	<META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="scripts/parse-1.6.14.min.js"></script>
    <script src="hungrybee.js"></script>
    <script src="scripts/hbParseInit.js"></script>
    <script src="scripts/hbUtility.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    <script src="scripts/jquery-2.2.0.min.js"></script>
    <script src="scripts/bootstrap.min.js"></script>
    <script src="scripts/xml2json.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">

    <title>小蜜蜂小幫手</title>
</head>
<body>

    <ul class="nav nav-pills">
        <li role="presentation" class="dropdown active">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                訂單查詢 <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                <li><a href="index.html?mode=id">訂單編號</a></li>
                <li><a href="index.html?mode=date">訂單日期</a></li>
                <li><a href="phoneSearch.html">依訂購人查詢</a></li>
            </ul>
            <!--<a href="index.html">訂單查詢</a>-->
        </li>

        <li role="presentation" class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                帳單查詢 <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                <li><a href="storeBill.html">店家帳單</a></li>
                <li><a href="beeShippingFee.html">小蜜蜂帳單</a></li>
            </ul>

        </li>

        <li role="presentation" class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                銀行匯款 <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                <li><a href="bankTransfer_store.html">店家匯款</a></li>
                <li><a href="bankTransfer_bee.html">小蜜蜂匯款</a></li>
            </ul>
        </li>

        <li role="presentation"><a href="storeManagement.html">店鋪管理</a></li>
        <li role="presentation" class="dropdown"><a href="beeManagement.html">小蜜蜂管理</a></li>
        <li role="presentation" class="dropdown"><a href="activeUserManagement.html">活動紀錄查詢</a></li>
        <li role="presentation" class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                其他 <span class="caret"></span>
            </a>

            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                <li><a href="coupon.html" target=_blank>折價卷產生器</a></li>
                <li><a href="holdOrderTool.html" target=_blank>卡單小幫手</a></li>
                <li><a href="" onclick="parseLogOut()">登出</a></li>
            </ul>
        </li>
        <li role="presentation" class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                即時資訊應用<span class="caret"></span>
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                <li><a href="weatherInfo.html">氣象資料</a></li>
                <li><a href="trafficInfo.html">交通路況</a></li>
                <li><a href="sendPush.html" target="_blank">發push</a>
            </ul>
        </li>
    </ul>

    <br>

    <div class="panel panel-default">
        <div class="panel-heading">交通路況</div>

        <div class="panel-body">
            <div class="navbar-form navbar-left">

                <div class="form-group">
					<button type="submit" class="btn btn-default" id="trafficSearchBtn1">查詢</button>
                </div>

                
            </div>

        </div>

        <table class="table table-striped ">
            <thead>
                <tr>
                    <th>#</th>
                    <th>日期</th>
                    <th>時間</th>
                    <th>地區</th>
                    <th>地點</th>
                    <th>資料來源</th>
                    <th>路況類別</th>
                    <th>路況說明</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="trafficTableBody"></tbody>
        </table>

    </div>

    <script>

        $('#trafficSearchBtn1').click(function () {
        	//讀取警廣資料
		    $.get("http://od.moi.gov.tw/data/api/pbs",
		    	function(data, status){
		        
		        var obj = jQuery.parseJSON(data);
		        var idx = 1;
		        var trafficResults = obj.result;
		        for(var i=0 ; i<trafficResults.length ; i++) {
		        	var trafficCondition = trafficResults[i];
		        	var area = trafficCondition.areaNm;
		        	
		        	if (area.indexOf("新竹") != -1) {
		        		console.log(trafficCondition);
		        		$('#trafficTableBody').append(
	                      $('<tr>').append(
	                          $('<td>').html(idx),
	                          $('<td>').html(trafficCondition.happendate),
	                          $('<td>').html(trafficCondition.happentime.substring(0,8)),
	                          $('<td>').html(trafficCondition.areaNm),
	                          $('<td id=point_' + i + '>').html(trafficCondition.y1 + "," + trafficCondition.x1),
	                          $('<td>').html(trafficCondition.srcdetail),
	                          $('<td id=roadtype_' + i + '>').html(trafficCondition.roadtype),
	                          $('<td id=comment_' + i + '>').html(trafficCondition.comment),
	                          $('<td>').html("<button onclick='report_traffic(" + i + ")'>通知小蜜蜂</button>")
	                        )
	                   );
	                	idx++;
		        	}
		        }
		    });
        });
        
        
        
        function report_traffic(idx) {
        	var point = $("#point_" + idx).html();
        	var lat = point.substring(0, point.indexOf(",") );
        	var lng = point.substring(point.indexOf(",") + 1);
        	var comment = $("#comment_" + idx).html();
        	var roadtype = $("#roadtype_" + idx).html();
        	Parse.Cloud.run("addTrafficReport", 
				{	
					lat: lat,
					lng: lng,
					reasons: roadtype,
					comment: comment
				}, 
				{
				success: function(results) {
					console.log("success:" + results);
					
				},
			 	error: function(error) {
			 		console.log("error:" + error);
				}
			});
        	
        }
      

    </script>
</body>
</html>